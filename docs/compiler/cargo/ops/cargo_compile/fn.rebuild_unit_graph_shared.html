<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This is used to rebuild the unit graph, sharing host dependencies if possible, and applying other unit adjustments based on the whole graph."><title>rebuild_unit_graph_shared in cargo::ops::cargo_compile - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-46132b98.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="cargo" data-themes="" data-resource-suffix="" data-rustdoc-version="1.85.0-nightly (0aeaa5eb2 2024-12-14)" data-channel="nightly" data-search-js="search-92e6798f.js" data-settings-js="settings-0f613d39.js" ><script src="../../../static.files/storage-59e33391.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-5f194d8c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../cargo/index.html">cargo</a><span class="version">1.85.0-nightly</span></h2></div><div class="version">(0aeaa5eb2	2024-12-14)</div><div class="sidebar-elems"><div id="rustdoc-modnav"><h2><a href="index.html">In cargo::<wbr>ops::<wbr>cargo_<wbr>compile</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">cargo</a>::<wbr><a href="../index.html">ops</a>::<wbr><a href="index.html">cargo_compile</a></span><h1>Function <span class="fn">rebuild_unit_graph_shared</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/cargo/ops/cargo_compile/mod.rs.html#585-618">Source</a> </span></div><pre class="rust item-decl"><code>fn rebuild_unit_graph_shared(
    interner: &amp;<a class="struct" href="../../core/compiler/unit/struct.UnitInterner.html" title="struct cargo::core::compiler::unit::UnitInterner">UnitInterner</a>,
    unit_graph: <a class="type" href="../../core/compiler/unit_graph/type.UnitGraph.html" title="type cargo::core::compiler::unit_graph::UnitGraph">UnitGraph</a>,
    roots: &amp;[<a class="struct" href="../../core/compiler/unit/struct.Unit.html" title="struct cargo::core::compiler::unit::Unit">Unit</a>],
    scrape_units: &amp;[<a class="struct" href="../../core/compiler/unit/struct.Unit.html" title="struct cargo::core::compiler::unit::Unit">Unit</a>],
    to_host: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="enum" href="../../core/compiler/compile_kind/enum.CompileKind.html" title="enum cargo::core::compiler::compile_kind::CompileKind">CompileKind</a>&gt;,
) -&gt; (<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../core/compiler/unit/struct.Unit.html" title="struct cargo::core::compiler::unit::Unit">Unit</a>&gt;, <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../core/compiler/unit/struct.Unit.html" title="struct cargo::core::compiler::unit::Unit">Unit</a>&gt;, <a class="type" href="../../core/compiler/unit_graph/type.UnitGraph.html" title="type cargo::core::compiler::unit_graph::UnitGraph">UnitGraph</a>)</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This is used to rebuild the unit graph, sharing host dependencies if possible,
and applying other unit adjustments based on the whole graph.</p>
<p>This will translate any unitâ€™s <code>CompileKind::Target(host)</code> to
<code>CompileKind::Host</code> if <code>to_host</code> is not <code>None</code> and the kind is equal to <code>to_host</code>.
This also handles generating the unit <code>dep_hash</code>, and merging shared units if possible.</p>
<p>This is necessary because if normal dependencies used <code>CompileKind::Host</code>,
there would be no way to distinguish those units from build-dependency
units or artifact dependency units.
This can cause a problem if a shared normal/build/artifact dependency needs
to link to another dependency whose features differ based on whether or
not it is a normal, build or artifact dependency. If all units used
<code>CompileKind::Host</code>, then they would end up being identical, causing a
collision in the <code>UnitGraph</code>, and Cargo would end up randomly choosing one
value or the other.</p>
<p>The solution is to keep normal, build and artifact dependencies separate when
building the unit graph, and then run this second pass which will try to
combine shared dependencies safely. By adding a hash of the dependencies
to the <code>Unit</code>, this allows the <code>CompileKind</code> to be changed back to <code>Host</code>
and <code>artifact_target_for_features</code> to be removed without fear of an unwanted
collision for build or artifact dependencies.</p>
<p>This is also responsible for adjusting the <code>strip</code> profile option to
opportunistically strip if debug is 0 for all dependencies. This helps
remove debuginfo added by the standard library.</p>
<p>This is also responsible for adjusting the <code>debug</code> setting for host
dependencies, turning off debug if the user has not explicitly enabled it,
and the unit is not shared with a target unit.</p>
</div></details></section></div></main></body></html>