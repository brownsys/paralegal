<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Support for tracking the last time files were used to assist with cleaning up those files if they havenâ€™t been used in a while."><title>cargo::core::global_cache_tracker - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-46132b98.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="cargo" data-themes="" data-resource-suffix="" data-rustdoc-version="1.85.0-nightly (0aeaa5eb2 2024-12-14)" data-channel="nightly" data-search-js="search-92e6798f.js" data-settings-js="settings-0f613d39.js" ><script src="../../../static.files/storage-59e33391.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-5f194d8c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../cargo/index.html">cargo</a><span class="version">1.85.0-nightly</span></h2></div><div class="version">(0aeaa5eb2	2024-12-14)</div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module global_<wbr>cache_<wbr>tracker</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#automatic-gc" title="Automatic gc">Automatic gc</a></li><li><a href="#manual-gc" title="Manual gc">Manual gc</a></li><li><a href="#locking" title="Locking">Locking</a></li><li><a href="#compatibility" title="Compatibility">Compatibility</a></li><li><a href="#performance" title="Performance">Performance</a></li><li><a href="#filesystems" title="Filesystems">Filesystems</a></li></ul><h3><a href="#macros">Module Items</a></h3><ul class="block"><li><a href="#macros" title="Macros">Macros</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#functions" title="Functions">Functions</a></li><li><a href="#types" title="Type Aliases">Type Aliases</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In cargo::<wbr>core</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">cargo</a>::<wbr><a href="../index.html">core</a></span><h1>Module <span>global_cache_tracker</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/cargo/core/global_cache_tracker.rs.html#1-1816">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Support for tracking the last time files were used to assist with cleaning
up those files if they havenâ€™t been used in a while.</p>
<p>Tracking of cache files is stored in a sqlite database which contains a
timestamp of the last time the file was used, as well as the size of the
file.</p>
<p>While cargo is running, when it detects a use of a cache file, it adds a
timestamp to <a href="struct.DeferredGlobalLastUse.html" title="struct cargo::core::global_cache_tracker::DeferredGlobalLastUse"><code>DeferredGlobalLastUse</code></a>. This batches up a set of changes
that are then flushed to the database all at once (via
<a href="struct.DeferredGlobalLastUse.html#method.save" title="method cargo::core::global_cache_tracker::DeferredGlobalLastUse::save"><code>DeferredGlobalLastUse::save</code></a>). Ideally saving would only be done once
for performance reasons, but that is not really possible due to the way
cargo works, since there are different ways cargo can be used (like <code>cargo generate-lockfile</code>, <code>cargo fetch</code>, and <code>cargo build</code> are all very
different ways the code is used).</p>
<p>All of the database interaction is done through the <a href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker"><code>GlobalCacheTracker</code></a>
type.</p>
<p>There is a single global <a href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker"><code>GlobalCacheTracker</code></a> and
<a href="struct.DeferredGlobalLastUse.html" title="struct cargo::core::global_cache_tracker::DeferredGlobalLastUse"><code>DeferredGlobalLastUse</code></a> stored in <a href="../../util/context/struct.GlobalContext.html" title="struct cargo::util::context::GlobalContext"><code>GlobalContext</code></a>.</p>
<p>The high-level interface for performing garbage collection is defined in
the <a href="../gc/index.html" title="mod cargo::core::gc"><code>crate::core::gc</code></a> module. The functions there are responsible for
interacting with the <a href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker"><code>GlobalCacheTracker</code></a> to handle cleaning of global
cache data.</p>
<h3 id="automatic-gc"><a class="doc-anchor" href="#automatic-gc">Â§</a>Automatic gc</h3>
<p>Some commands (primarily the build commands) will trigger an automatic
deletion of files that havenâ€™t been used in a while. The high-level
interface for this is the <a href="../gc/fn.auto_gc.html" title="fn cargo::core::gc::auto_gc"><code>crate::core::gc::auto_gc</code></a> function.</p>
<p>The <a href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker"><code>GlobalCacheTracker</code></a> database tracks the last time an automatic gc
was performed so that it is only done once per day for performance
reasons.</p>
<h3 id="manual-gc"><a class="doc-anchor" href="#manual-gc">Â§</a>Manual gc</h3>
<p>The user can perform a manual garbage collection with the <code>cargo clean</code>
command. That command has a variety of options to specify what to delete.
Manual gc supports deleting based on age or size or both. From a
high-level, this is done by the <a href="../gc/struct.Gc.html#method.gc" title="method cargo::core::gc::Gc::gc"><code>crate::core::gc::Gc::gc</code></a> method, which
calls into <a href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker"><code>GlobalCacheTracker</code></a> to handle all the cleaning.</p>
<h3 id="locking"><a class="doc-anchor" href="#locking">Â§</a>Locking</h3>
<p>Usage of the database requires that the package cache is locked to prevent
concurrent access. Although sqlite has built-in locking support, we want
to use cargoâ€™s locking so that the â€œBlockingâ€ message gets displayed, and
so that locks can block indefinitely for long-running build commands.
[<code>rusqlite</code>] has a default timeout of 5 seconds, though that is
configurable.</p>
<p>When garbage collection is being performed, the package cache lock must be
in <a href="../../util/cache_lock/enum.CacheLockMode.html#variant.MutateExclusive" title="variant cargo::util::cache_lock::CacheLockMode::MutateExclusive"><code>CacheLockMode::MutateExclusive</code></a> to ensure no other cargo process is
running. See <a href="../../util/cache_lock/index.html" title="mod cargo::util::cache_lock"><code>crate::util::cache_lock</code></a> for more detail on locking.</p>
<p>When performing automatic gc, <a href="../gc/fn.auto_gc.html" title="fn cargo::core::gc::auto_gc"><code>crate::core::gc::auto_gc</code></a> will skip the
GC if the package cache lock is already held by anything else. Automatic
GC is intended to be opportunistic, and should impose as little disruption
to the user as possible.</p>
<h3 id="compatibility"><a class="doc-anchor" href="#compatibility">Â§</a>Compatibility</h3>
<p>The database must retain both forwards and backwards compatibility between
different versions of cargo. For the most part, this shouldnâ€™t be too
difficult to maintain. Generally sqlite doesnâ€™t change on-disk formats
between versions (the introduction of WAL is one of the few examples where
version 3 had a format change, but we wouldnâ€™t use it anyway since it has
shared-memory requirements cargo canâ€™t depend on due to things like
network mounts).</p>
<p>Schema changes must be managed through <a href="fn.migrations.html" title="fn cargo::core::global_cache_tracker::migrations"><code>migrations</code></a> by adding new
entries that make a change to the database. Changes must not break older
versions of cargo. Generally, adding columns should be fine (either with a
default value, or NULL). Adding tables should also be fine. Just donâ€™t do
destructive things like removing a column, or changing the semantics of an
existing column.</p>
<p>Since users may run older versions of cargo that do not do cache tracking,
the <a href="struct.GlobalCacheTracker.html#method.sync_db_with_files" title="associated function cargo::core::global_cache_tracker::GlobalCacheTracker::sync_db_with_files"><code>GlobalCacheTracker::sync_db_with_files</code></a> method helps dealing with
keeping the database in sync in the presence of older versions of cargo
touching the cache directories.</p>
<h3 id="performance"><a class="doc-anchor" href="#performance">Â§</a>Performance</h3>
<p>A lot of focus on the design of this system is to minimize the performance
impact. Every build command needs to save updates which we try to avoid
having a noticeable impact on build times. Systems like Windows,
particularly with a magnetic hard disk, can experience a fairly large
impact of cargoâ€™s overhead. Cargoâ€™s benchsuite has some benchmarks to help
compare different environments, or changes to the code here. Please try to
keep performance in mind if making any major changes.</p>
<p>Performance of <code>cargo clean</code> is not quite as important since it is not
expected to be run often. However, it is still courteous to the user to
try to not impact it too much. One part that has a performance concern is
that the clean command will synchronize the database with whatever is on
disk if needed (in case files were added by older versions of cargo that
donâ€™t do cache tracking, or if the user manually deleted some files). This
can potentially be very slow, especially if the two are very out of sync.</p>
<h3 id="filesystems"><a class="doc-anchor" href="#filesystems">Â§</a>Filesystems</h3>
<p>Everything here is sensitive to the kind of filesystem it is running on.
People tend to run cargo in all sorts of strange environments that have
limited capabilities, or on things like read-only mounts. The code here
needs to gracefully handle as many situations as possible.</p>
<p>See also the information in the <a href="#performance">Performance</a> and
<a href="#locking">Locking</a> sections when considering different filesystems and
their impact on performance and locking.</p>
<p>There are checks for read-only filesystems, which is generally ignored.</p>
</div></details><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.insert_or_update_parent.html" title="macro cargo::core::global_cache_tracker::insert_or_update_parent">insert_<wbr>or_<wbr>update_<wbr>parent</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Helper to generate the upsert for the parent tables.</div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BasePaths.html" title="struct cargo::core::global_cache_tracker::BasePaths">Base<wbr>Paths</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Filesystem paths in the global cache.</div></li><li><div class="item-name"><a class="struct" href="struct.DeferredGlobalLastUse.html" title="struct cargo::core::global_cache_tracker::DeferredGlobalLastUse">Deferred<wbr>Global<wbr>Last<wbr>Use</a></div><div class="desc docblock-short">This is a cache of modifications that will be saved to disk all at once
via the <a href="struct.DeferredGlobalLastUse.html#method.save" title="method cargo::core::global_cache_tracker::DeferredGlobalLastUse::save"><code>DeferredGlobalLastUse::save</code></a> method.</div></li><li><div class="item-name"><a class="struct" href="struct.GitCheckout.html" title="struct cargo::core::global_cache_tracker::GitCheckout">GitCheckout</a></div><div class="desc docblock-short">The key for a git checkout entry stored in the database.</div></li><li><div class="item-name"><a class="struct" href="struct.GitDb.html" title="struct cargo::core::global_cache_tracker::GitDb">GitDb</a></div><div class="desc docblock-short">The key for a git db entry stored in the database.</div></li><li><div class="item-name"><a class="struct" href="struct.GlobalCacheTracker.html" title="struct cargo::core::global_cache_tracker::GlobalCacheTracker">Global<wbr>Cache<wbr>Tracker</a></div><div class="desc docblock-short">Tracking for the global shared cache (registry files, etc.).</div></li><li><div class="item-name"><a class="struct" href="struct.ParentId.html" title="struct cargo::core::global_cache_tracker::ParentId">Parent<wbr>Id</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Type for SQL columns that refer to the primary key of their parent table.</div></li><li><div class="item-name"><a class="struct" href="struct.RegistryCrate.html" title="struct cargo::core::global_cache_tracker::RegistryCrate">Registry<wbr>Crate</a></div><div class="desc docblock-short">The key for a registry <code>.crate</code> entry stored in the database.</div></li><li><div class="item-name"><a class="struct" href="struct.RegistryIndex.html" title="struct cargo::core::global_cache_tracker::RegistryIndex">Registry<wbr>Index</a></div><div class="desc docblock-short">The key for a registry index entry stored in the database.</div></li><li><div class="item-name"><a class="struct" href="struct.RegistrySrc.html" title="struct cargo::core::global_cache_tracker::RegistrySrc">Registry<wbr>Src</a></div><div class="desc docblock-short">The key for a registry src directory entry stored in the database.</div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.GIT_CO_TABLE.html" title="constant cargo::core::global_cache_tracker::GIT_CO_TABLE">GIT_<wbr>CO_<wbr>TABLE</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.GIT_DB_TABLE.html" title="constant cargo::core::global_cache_tracker::GIT_DB_TABLE">GIT_<wbr>DB_<wbr>TABLE</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.GLOBAL_CACHE_FILENAME.html" title="constant cargo::core::global_cache_tracker::GLOBAL_CACHE_FILENAME">GLOBAL_<wbr>CACHE_<wbr>FILENAME</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">The filename of the database.</div></li><li><div class="item-name"><a class="constant" href="constant.REGISTRY_CRATE_TABLE.html" title="constant cargo::core::global_cache_tracker::REGISTRY_CRATE_TABLE">REGISTRY_<wbr>CRATE_<wbr>TABLE</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.REGISTRY_INDEX_TABLE.html" title="constant cargo::core::global_cache_tracker::REGISTRY_INDEX_TABLE">REGISTRY_<wbr>INDEX_<wbr>TABLE</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.REGISTRY_SRC_TABLE.html" title="constant cargo::core::global_cache_tracker::REGISTRY_SRC_TABLE">REGISTRY_<wbr>SRC_<wbr>TABLE</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.UPDATE_RESOLUTION.html" title="constant cargo::core::global_cache_tracker::UPDATE_RESOLUTION">UPDATE_<wbr>RESOLUTION</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">How often timestamps will be updated.</div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.du.html" title="fn cargo::core::global_cache_tracker::du">du</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.du_git_checkout.html" title="fn cargo::core::global_cache_tracker::du_git_checkout">du_<wbr>git_<wbr>checkout</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Returns the disk usage for a git checkout directory.</div></li><li><div class="item-name"><a class="fn" href="fn.is_silent_error.html" title="fn cargo::core::global_cache_tracker::is_silent_error">is_<wbr>silent_<wbr>error</a></div><div class="desc docblock-short">Returns whether or not the given error should cause a warning to be
displayed to the user.</div></li><li><div class="item-name"><a class="fn" href="fn.migrations.html" title="fn cargo::core::global_cache_tracker::migrations">migrations</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Migrations which initialize the database, and can be used to evolve it over time.</div></li><li><div class="item-name"><a class="fn" href="fn.now.html" title="fn cargo::core::global_cache_tracker::now">now</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Returns the current time.</div></li><li><div class="item-name"><a class="fn" href="fn.to_timestamp.html" title="fn cargo::core::global_cache_tracker::to_timestamp">to_<wbr>timestamp</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Converts a <a href="https://doc.rust-lang.org/nightly/std/time/struct.SystemTime.html" title="struct std::time::SystemTime"><code>SystemTime</code></a> to a <a href="type.Timestamp.html" title="type cargo::core::global_cache_tracker::Timestamp"><code>Timestamp</code></a> which can be stored in the database.</div></li></ul><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.Timestamp.html" title="type cargo::core::global_cache_tracker::Timestamp">Timestamp</a><span title="Restricted Visibility">&nbsp;ğŸ”’</span> </div><div class="desc docblock-short">Type for timestamps as stored in the database.</div></li></ul></section></div></main></body></html>